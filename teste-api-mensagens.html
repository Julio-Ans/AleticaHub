<!DOCTYPE html>
<html>
<head>
    <title>🧪 Teste Envio de Mensagens - API</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #030712; 
            color: #fff; 
            padding: 20px; 
            margin: 0;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .result { background: #222; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { border-left: 4px solid #0f0; }
        .error { border-left: 4px solid #f00; }
        .warning { border-left: 4px solid #ff0; }
        button { background: #0066cc; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px; cursor: pointer; }
        button:hover { background: #004499; }
        input, textarea { background: #333; color: white; border: 1px solid #555; padding: 8px; margin: 5px; border-radius: 4px; }
        textarea { width: 300px; height: 100px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Teste API de Mensagens</h1>
        
        <div>
            <h3>Token de Autenticação:</h3>
            <input type="text" id="token" placeholder="Cole o token aqui" style="width: 400px;">
            <button onclick="getTokenFromStorage()">🔑 Pegar do LocalStorage</button>
        </div>

        <div>
            <h3>Parâmetros da Mensagem:</h3>
            <input type="text" id="esporteId" placeholder="Esporte ID (0 para geral)" value="0">
            <br>
            <textarea id="conteudo" placeholder="Digite a mensagem aqui...">Teste de mensagem via API</textarea>
            <br>
            <button onclick="enviarMensagem()">📤 Enviar Mensagem</button>
            <button onclick="buscarMensagens()">📥 Buscar Mensagens</button>
            <button onclick="limpar()">🧹 Limpar</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const baseURL = 'https://atleticahubapi.onrender.com';
        
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const logDiv = document.createElement('div');
            logDiv.className = `result ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            resultsDiv.appendChild(logDiv);
            console.log(message);
        }

        function limpar() {
            document.getElementById('results').innerHTML = '';
        }

        function getTokenFromStorage() {
            const token = localStorage.getItem('athletica_token') || localStorage.getItem('authToken');
            if (token) {
                document.getElementById('token').value = token;
                log('✅ Token encontrado no localStorage', 'success');
            } else {
                log('❌ Nenhum token encontrado no localStorage', 'error');
            }
        }

        async function enviarMensagem() {
            const token = document.getElementById('token').value;
            const esporteId = document.getElementById('esporteId').value;
            const conteudo = document.getElementById('conteudo').value;

            if (!token) {
                log('❌ Token obrigatório', 'error');
                return;
            }

            if (!conteudo.trim()) {
                log('❌ Conteúdo da mensagem obrigatório', 'error');
                return;
            }

            try {
                log('📤 Enviando mensagem...', 'warning');
                log(`📋 Dados: esporteId=${esporteId}, conteudo="${conteudo}"`, 'warning');

                const response = await fetch(`${baseURL}/api/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        esporteId: esporteId,
                        conteudo: conteudo.trim()
                    })
                });

                log(`📡 Response Status: ${response.status} ${response.statusText}`, 'warning');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`❌ Erro HTTP ${response.status}: ${errorText}`, 'error');
                    return;
                }

                const data = await response.json();
                log(`✅ Mensagem enviada com sucesso!`, 'success');
                log(`📨 Resposta: ${JSON.stringify(data, null, 2)}`, 'success');

            } catch (error) {
                log(`❌ Erro de rede: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }

        async function buscarMensagens() {
            const token = document.getElementById('token').value;
            const esporteId = document.getElementById('esporteId').value;

            if (!token) {
                log('❌ Token obrigatório', 'error');
                return;
            }

            try {
                log(`📥 Buscando mensagens do esporte ${esporteId}...`, 'warning');

                const response = await fetch(`${baseURL}/api/mensagens/${esporteId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`📡 Response Status: ${response.status} ${response.statusText}`, 'warning');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`❌ Erro HTTP ${response.status}: ${errorText}`, 'error');
                    return;
                }

                const mensagens = await response.json();
                log(`✅ ${mensagens.length} mensagem(ns) encontrada(s)`, 'success');
                log(`📥 Mensagens: ${JSON.stringify(mensagens, null, 2)}`, 'success');

            } catch (error) {
                log(`❌ Erro de rede: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }

        // Auto-carregar token ao abrir a página
        window.onload = () => {
            getTokenFromStorage();
        };
    </script>
</body>
</html>
