<!DOCTYPE html>
<html>
<head>
    <title>🔧 Teste Final - Sistema de Mensagens</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #222; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #0066cc; }
        .result { background: #333; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { border-left: 4px solid #0f0; }
        .error { border-left: 4px solid #f00; }
        .warning { border-left: 4px solid #ff0; }
        .info { border-left: 4px solid #0ff; }
        button { background: #0066cc; color: white; padding: 12px 20px; border: none; border-radius: 4px; margin: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0088ee; }
        button:disabled { background: #555; cursor: not-allowed; }
        pre { background: #000; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; font-size: 12px; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.ok { background: #0f0; color: #000; }
        .status.error { background: #f00; color: #fff; }
        .status.pending { background: #ff0; color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Teste Final - Sistema de Mensagens AtleticaHub</h1>
        <p>Diagnóstico completo do problema: "mensagens não aparecem, só usuário e data"</p>
        
        <div class="section">
            <h3>📋 Status do Sistema</h3>
            <div id="system-status">
                <p>🔄 Verificando sistema...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>🔑 Autenticação</h3>
            <button onclick="verificarAuth()">🔍 Verificar Token</button>
            <button onclick="limparAuth()" style="background: #d63384;">🧹 Limpar Auth</button>
            <div id="auth-results"></div>
        </div>
        
        <div class="section">
            <h3>📡 API - Chat Geral</h3>
            <button onclick="buscarMensagensGeral()">📥 Buscar Mensagens</button>
            <button onclick="enviarMensagemTeste()">📤 Enviar Teste</button>
            <button onclick="analisarEstrutura()">🔍 Analisar Estrutura</button>
            <div id="api-results"></div>
        </div>
        
        <div class="section">
            <h3>🖥️ Frontend - Simulação</h3>
            <button onclick="simularModal()">🎭 Simular Modal</button>
            <button onclick="simularFiltros()">🔍 Simular Filtros</button>
            <button onclick="simularRenderizacao()">🎨 Simular Renderização</button>
            <div id="frontend-results"></div>
        </div>
        
        <div class="section">
            <h3>🎯 Teste Final</h3>
            <button onclick="testeCompleto()" style="background: #198754; font-size: 16px; padding: 15px 25px;">🚀 EXECUTAR TESTE COMPLETO</button>
            <div id="final-results"></div>
        </div>
    </div>

    <script>
        const baseURL = 'https://atleticahubapi.onrender.com';
        let globalToken = null;
        let mensagensEncontradas = [];
        
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            container.appendChild(div);
            console.log(`[${containerId}] ${message}`);
        }
        
        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function updateSystemStatus(message, type = 'pending') {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = `<p><span class="status ${type}">${type.toUpperCase()}</span> ${message}</p>`;
        }

        async function verificarAuth() {
            clearResults('auth-results');
            log('auth-results', '🔍 Verificando autenticação...', 'info');
            
            const authToken = localStorage.getItem('authToken');
            const athleticaToken = localStorage.getItem('athletica_token');
            
            log('auth-results', `authToken: ${authToken ? '✅ Encontrado' : '❌ Não encontrado'}`, authToken ? 'success' : 'error');
            log('auth-results', `athletica_token: ${athleticaToken ? '✅ Encontrado' : '❌ Não encontrado'}`, athleticaToken ? 'success' : 'error');
            
            globalToken = authToken || athleticaToken;
            
            if (globalToken) {
                log('auth-results', `🔑 Token selecionado: ${globalToken.substring(0, 40)}...`, 'success');
                
                // Verificar se token é válido
                try {
                    const response = await fetch(`${baseURL}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${globalToken}` }
                    });
                    
                    if (response.ok) {
                        const user = await response.json();
                        log('auth-results', `👤 Usuário válido: ${user.nome} (${user.email})`, 'success');
                        updateSystemStatus('Autenticação OK', 'ok');
                        return true;
                    } else {
                        log('auth-results', `❌ Token inválido: ${response.status}`, 'error');
                        updateSystemStatus('Token inválido', 'error');
                        return false;
                    }
                } catch (error) {
                    log('auth-results', `❌ Erro ao validar token: ${error.message}`, 'error');
                    updateSystemStatus('Erro de rede', 'error');
                    return false;
                }
            } else {
                log('auth-results', '❌ Nenhum token encontrado! Faça login primeiro.', 'error');
                updateSystemStatus('Sem autenticação', 'error');
                return false;
            }
        }

        function limparAuth() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('athletica_token');
            localStorage.removeItem('user');
            globalToken = null;
            clearResults('auth-results');
            log('auth-results', '🧹 Todos os dados de autenticação foram limpos', 'info');
            updateSystemStatus('Auth limpa', 'pending');
        }

        async function buscarMensagensGeral() {
            clearResults('api-results');
            
            if (!globalToken) {
                log('api-results', '❌ Execute "Verificar Token" primeiro!', 'error');
                return;
            }
            
            log('api-results', '📥 Buscando mensagens do Chat Geral (esporteId: 0)...', 'info');
            
            try {
                const response = await fetch(`${baseURL}/api/mensagens/0`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${globalToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                log('api-results', `📡 Status: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const mensagens = await response.json();
                    mensagensEncontradas = mensagens;
                    
                    log('api-results', `✅ ${mensagens.length} mensagem(ns) encontrada(s)`, 'success');
                    
                    if (mensagens.length > 0) {
                        log('api-results', '📋 Estrutura das mensagens:', 'info');
                        log('api-results', `<pre>${JSON.stringify(mensagens, null, 2)}</pre>`, 'info');
                        
                        // Análise dos problemas
                        let problemasEncontrados = 0;
                        mensagens.forEach((msg, index) => {
                            const temTexto = msg.texto && msg.texto.trim() !== '';
                            const temConteudo = msg.conteudo && msg.conteudo.trim() !== '';
                            const temNome = msg.remetente?.nome && msg.remetente.nome.trim() !== '';
                            
                            if (!temTexto && !temConteudo) {
                                log('api-results', `❌ Mensagem ${index + 1}: SEM CONTEÚDO`, 'error');
                                problemasEncontrados++;
                            }
                            
                            if (!temNome) {
                                log('api-results', `❌ Mensagem ${index + 1}: SEM NOME DO REMETENTE`, 'error');
                                problemasEncontrados++;
                            }
                        });
                        
                        if (problemasEncontrados === 0) {
                            log('api-results', '✅ Todas as mensagens têm dados completos!', 'success');
                        } else {
                            log('api-results', `⚠️ ${problemasEncontrados} problema(s) encontrado(s) nos dados`, 'warning');
                        }
                    } else {
                        log('api-results', '📝 Nenhuma mensagem no Chat Geral (normal se não há mensagens)', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log('api-results', `❌ Erro HTTP: ${errorText}`, 'error');
                    
                    if (response.status === 404) {
                        log('api-results', '💡 404: Chat Geral pode não existir ainda', 'warning');
                    } else if (response.status === 403) {
                        log('api-results', '💡 403: Problema de permissão', 'warning');
                    }
                }
                
            } catch (error) {
                log('api-results', `❌ Erro de rede: ${error.message}`, 'error');
            }
        }

        async function enviarMensagemTeste() {
            if (!globalToken) {
                log('api-results', '❌ Execute "Verificar Token" primeiro!', 'error');
                return;
            }
            
            const mensagemTeste = `🧪 Teste de debug - ${new Date().toLocaleTimeString()}`;
            log('api-results', `📤 Enviando: "${mensagemTeste}"`, 'info');
            
            try {
                const response = await fetch(`${baseURL}/api/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${globalToken}`
                    },
                    body: JSON.stringify({
                        esporteId: "0",
                        texto: mensagemTeste
                    })
                });

                log('api-results', `📡 Status envio: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const novaMensagem = await response.json();
                    log('api-results', '✅ Mensagem enviada com sucesso!', 'success');
                    log('api-results', `<pre>${JSON.stringify(novaMensagem, null, 2)}</pre>`, 'success');
                    
                    // Aguardar e buscar novamente
                    setTimeout(() => {
                        log('api-results', '🔄 Buscando mensagens novamente...', 'info');
                        buscarMensagensGeral();
                    }, 1000);
                } else {
                    const errorText = await response.text();
                    log('api-results', `❌ Erro ao enviar: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log('api-results', `❌ Erro de rede: ${error.message}`, 'error');
            }
        }

        function analisarEstrutura() {
            clearResults('api-results');
            
            if (mensagensEncontradas.length === 0) {
                log('api-results', '⚠️ Execute "Buscar Mensagens" primeiro!', 'warning');
                return;
            }
            
            log('api-results', '🔍 Analisando estrutura dos dados...', 'info');
            
            mensagensEncontradas.forEach((msg, index) => {
                log('api-results', `📨 Análise da Mensagem ${index + 1}:`, 'info');
                log('api-results', `   ID: ${msg.id || 'AUSENTE'}`, msg.id ? 'success' : 'error');
                log('api-results', `   EsporteId: ${msg.esporteId || 'AUSENTE'}`, msg.esporteId ? 'success' : 'error');
                log('api-results', `   Texto: "${msg.texto || 'VAZIO'}"`, msg.texto ? 'success' : 'error');
                log('api-results', `   Conteudo: "${msg.conteudo || 'VAZIO'}"`, msg.conteudo ? 'success' : 'error');
                log('api-results', `   Remetente.nome: "${msg.remetente?.nome || 'VAZIO'}"`, msg.remetente?.nome ? 'success' : 'error');
                log('api-results', `   Remetente.email: "${msg.remetente?.email || 'VAZIO'}"`, msg.remetente?.email ? 'success' : 'error');
                log('api-results', `   Data: ${msg.criadaEm || 'AUSENTE'}`, msg.criadaEm ? 'success' : 'error');
                
                // Simular como apareceria no frontend
                const textoFinal = msg.texto || 'Mensagem sem conteúdo';
                const nomeFinal = msg.remetente?.nome || 'Usuário';
                
                log('api-results', `   👁️ Como apareceria: "${nomeFinal}: ${textoFinal}"`, 'info');
                
                if (textoFinal === 'Mensagem sem conteúdo' && nomeFinal === 'Usuário') {
                    log('api-results', '   🎯 BINGO! Este é o problema relatado!', 'error');
                } else if (textoFinal === 'Mensagem sem conteúdo') {
                    log('api-results', '   ⚠️ Problema: Sem conteúdo da mensagem', 'warning');
                } else if (nomeFinal === 'Usuário') {
                    log('api-results', '   ⚠️ Problema: Sem nome do remetente', 'warning');
                } else {
                    log('api-results', '   ✅ Dados OK para esta mensagem', 'success');
                }
            });
        }

        function simularModal() {
            clearResults('frontend-results');
            log('frontend-results', '🎭 Simulando comportamento do ModalMensagens...', 'info');
            
            // Simular dados problemáticos
            const mensagensSimuladas = [
                {
                    id: "1",
                    esporteId: "0",
                    texto: "",
                    remetente: { nome: "" },
                    criadaEm: new Date().toISOString()
                },
                {
                    id: "2", 
                    esporteId: "0",
                    texto: "Mensagem normal",
                    remetente: { nome: "João Silva" },
                    criadaEm: new Date().toISOString()
                }
            ];
            
            log('frontend-results', '📋 Dados simulados:', 'info');
            log('frontend-results', `<pre>${JSON.stringify(mensagensSimuladas, null, 2)}</pre>`, 'info');
            
            // Simular renderização (código do ModalMensagens.tsx)
            log('frontend-results', '🎨 Simulando renderização do React:', 'info');
            
            mensagensSimuladas.forEach((mensagem, index) => {
                // Código do ModalMensagens.tsx linhas 243-255
                const nomeExibido = mensagem.remetente?.nome || 'Usuário';
                const textoExibido = mensagem.texto || 'Mensagem sem conteúdo';
                
                log('frontend-results', `Mensagem ${index + 1}:`, 'info');
                log('frontend-results', `   Nome: "${nomeExibido}"`, nomeExibido === 'Usuário' ? 'error' : 'success');
                log('frontend-results', `   Texto: "${textoExibido}"`, textoExibido === 'Mensagem sem conteúdo' ? 'error' : 'success');
                
                if (nomeExibido === 'Usuário' && textoExibido === 'Mensagem sem conteúdo') {
                    log('frontend-results', '   🎯 REPRODUZIU O PROBLEMA!', 'error');
                }
            });
        }

        function simularFiltros() {
            clearResults('frontend-results');
            log('frontend-results', '🔍 Testando filtros do frontend...', 'info');
            
            const mensagemsChatGeral = [
                { id: "1", esporteId: "0", texto: "Msg 1" },
                { id: "2", esporteId: "0", texto: "Msg 2" },
                { id: "3", esporteId: "1", texto: "Msg de outro esporte" }
            ];
            
            log('frontend-results', '📋 Mensagens originais (3 total):', 'info');
            log('frontend-results', `<pre>${JSON.stringify(mensagemsChatGeral, null, 2)}</pre>`, 'info');
            
            // Filtro ANTIGO (problemático) - REMOVIDO na correção
            log('frontend-results', '❌ Filtro ANTIGO (problemático - JÁ REMOVIDO):', 'error');
            const filtroAntigo = mensagemsChatGeral.filter(msg => msg.esporteId === "0");
            log('frontend-results', `   Resultado: ${filtroAntigo.length} mensagens`, 'error');
            log('frontend-results', '   Problema: API já filtra, filtro duplo remove tudo!', 'error');
            
            // Comportamento NOVO (corrigido)
            log('frontend-results', '✅ Comportamento NOVO (corrigido):', 'success');
            log('frontend-results', `   Resultado: ${mensagemsChatGeral.length} mensagens (sem filtro extra)`, 'success');
            log('frontend-results', '   Correção: Removido filtro duplo desnecessário', 'success');
        }

        function simularRenderizacao() {
            clearResults('frontend-results');
            log('frontend-results', '🎨 Simulando renderização completa...', 'info');
            
            if (mensagensEncontradas.length === 0) {
                log('frontend-results', '⚠️ Execute "Buscar Mensagens" primeiro para dados reais!', 'warning');
                return;
            }
            
            // Usar dados reais da API
            log('frontend-results', `📨 Renderizando ${mensagensEncontradas.length} mensagem(ns) real(is):`, 'info');
            
            mensagensEncontradas.forEach((mensagem, index) => {
                // Código exato do ModalMensagens.tsx
                const nomeExibido = mensagem.remetente?.nome || 'Usuário';
                const textoExibido = mensagem.texto || 'Mensagem sem conteúdo';
                const dataExibida = new Date(mensagem.criadaEm).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                log('frontend-results', `📨 Mensagem ${index + 1} renderizada:`, 'info');
                log('frontend-results', `   👤 Nome: "${nomeExibido}"`, 'info');
                log('frontend-results', `   💬 Texto: "${textoExibido}"`, 'info');
                log('frontend-results', `   📅 Data: "${dataExibida}"`, 'info');
                
                // Verificar se é o problema relatado
                if (nomeExibido === 'Usuário' && textoExibido === 'Mensagem sem conteúdo') {
                    log('frontend-results', '   🎯 PROBLEMA IDENTIFICADO: Só mostra "usuário" e data!', 'error');
                } else if (nomeExibido === 'Usuário') {
                    log('frontend-results', '   ⚠️ Problema parcial: Nome genérico', 'warning');
                } else if (textoExibido === 'Mensagem sem conteúdo') {
                    log('frontend-results', '   ⚠️ Problema parcial: Sem conteúdo', 'warning');
                } else {
                    log('frontend-results', '   ✅ Esta mensagem renderiza corretamente', 'success');
                }
            });
        }

        async function testeCompleto() {
            clearResults('final-results');
            log('final-results', '🚀 EXECUTANDO TESTE COMPLETO...', 'info');
            
            updateSystemStatus('Executando teste completo...', 'pending');
            
            // 1. Verificar autenticação
            log('final-results', '1️⃣ Verificando autenticação...', 'info');
            const authOk = await verificarAuth();
            
            if (!authOk) {
                log('final-results', '❌ FALHA: Sem autenticação válida', 'error');
                updateSystemStatus('Teste falhou - sem auth', 'error');
                return;
            }
            
            // 2. Buscar mensagens
            log('final-results', '2️⃣ Buscando mensagens...', 'info');
            await buscarMensagensGeral();
            
            // 3. Análise final
            log('final-results', '3️⃣ Análise final...', 'info');
            
            if (mensagensEncontradas.length === 0) {
                log('final-results', '⚠️ RESULTADO: Nenhuma mensagem encontrada', 'warning');
                log('final-results', '💡 Isso pode ser normal se o chat está vazio', 'info');
                log('final-results', '🔧 AÇÃO: Tente enviar uma mensagem de teste', 'info');
                updateSystemStatus('Chat vazio (normal)', 'ok');
            } else {
                let problemasEncontrados = 0;
                let mensagensOk = 0;
                
                mensagensEncontradas.forEach(msg => {
                    const temTexto = msg.texto && msg.texto.trim() !== '';
                    const temNome = msg.remetente?.nome && msg.remetente.nome.trim() !== '';
                    
                    if (!temTexto || !temNome) {
                        problemasEncontrados++;
                    } else {
                        mensagensOk++;
                    }
                });
                
                if (problemasEncontrados === 0) {
                    log('final-results', '✅ RESULTADO: Todas as mensagens estão OK!', 'success');
                    log('final-results', '🎉 O problema foi CORRIGIDO!', 'success');
                    updateSystemStatus('Sistema funcionando', 'ok');
                } else {
                    log('final-results', `❌ RESULTADO: ${problemasEncontrados} mensagem(ns) com problema`, 'error');
                    log('final-results', `✅ ${mensagensOk} mensagem(ns) funcionando corretamente`, 'success');
                    log('final-results', '🔧 PROBLEMA: Dados incompletos do backend', 'error');
                    updateSystemStatus('Dados incompletos', 'error');
                }
            }
            
            log('final-results', '🏁 TESTE COMPLETO FINALIZADO', 'info');
        }

        // Auto-executar verificação inicial
        window.onload = () => {
            updateSystemStatus('Carregando...', 'pending');
            verificarAuth();
        };
    </script>
</body>
</html>
