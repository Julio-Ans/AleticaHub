<!DOCTYPE html>
<html>
<head>
    <title>üîß Teste Final - Sistema de Mensagens</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: #222; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #0066cc; }
        .result { background: #333; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { border-left: 4px solid #0f0; }
        .error { border-left: 4px solid #f00; }
        .warning { border-left: 4px solid #ff0; }
        .info { border-left: 4px solid #0ff; }
        button { background: #0066cc; color: white; padding: 12px 20px; border: none; border-radius: 4px; margin: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0088ee; }
        button:disabled { background: #555; cursor: not-allowed; }
        pre { background: #000; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; font-size: 12px; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.ok { background: #0f0; color: #000; }
        .status.error { background: #f00; color: #fff; }
        .status.pending { background: #ff0; color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste Final - Sistema de Mensagens AtleticaHub</h1>
        <p>Diagn√≥stico completo do problema: "mensagens n√£o aparecem, s√≥ usu√°rio e data"</p>
        
        <div class="section">
            <h3>üìã Status do Sistema</h3>
            <div id="system-status">
                <p>üîÑ Verificando sistema...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>üîë Autentica√ß√£o</h3>
            <button onclick="verificarAuth()">üîç Verificar Token</button>
            <button onclick="limparAuth()" style="background: #d63384;">üßπ Limpar Auth</button>
            <div id="auth-results"></div>
        </div>
        
        <div class="section">
            <h3>üì° API - Chat Geral</h3>
            <button onclick="buscarMensagensGeral()">üì• Buscar Mensagens</button>
            <button onclick="enviarMensagemTeste()">üì§ Enviar Teste</button>
            <button onclick="analisarEstrutura()">üîç Analisar Estrutura</button>
            <div id="api-results"></div>
        </div>
        
        <div class="section">
            <h3>üñ•Ô∏è Frontend - Simula√ß√£o</h3>
            <button onclick="simularModal()">üé≠ Simular Modal</button>
            <button onclick="simularFiltros()">üîç Simular Filtros</button>
            <button onclick="simularRenderizacao()">üé® Simular Renderiza√ß√£o</button>
            <div id="frontend-results"></div>
        </div>
        
        <div class="section">
            <h3>üéØ Teste Final</h3>
            <button onclick="testeCompleto()" style="background: #198754; font-size: 16px; padding: 15px 25px;">üöÄ EXECUTAR TESTE COMPLETO</button>
            <div id="final-results"></div>
        </div>
    </div>

    <script>
        const baseURL = 'https://atleticahubapi.onrender.com';
        let globalToken = null;
        let mensagensEncontradas = [];
        
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            container.appendChild(div);
            console.log(`[${containerId}] ${message}`);
        }
        
        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function updateSystemStatus(message, type = 'pending') {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = `<p><span class="status ${type}">${type.toUpperCase()}</span> ${message}</p>`;
        }

        async function verificarAuth() {
            clearResults('auth-results');
            log('auth-results', 'üîç Verificando autentica√ß√£o...', 'info');
            
            const authToken = localStorage.getItem('authToken');
            const athleticaToken = localStorage.getItem('athletica_token');
            
            log('auth-results', `authToken: ${authToken ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado'}`, authToken ? 'success' : 'error');
            log('auth-results', `athletica_token: ${athleticaToken ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado'}`, athleticaToken ? 'success' : 'error');
            
            globalToken = authToken || athleticaToken;
            
            if (globalToken) {
                log('auth-results', `üîë Token selecionado: ${globalToken.substring(0, 40)}...`, 'success');
                
                // Verificar se token √© v√°lido
                try {
                    const response = await fetch(`${baseURL}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${globalToken}` }
                    });
                    
                    if (response.ok) {
                        const user = await response.json();
                        log('auth-results', `üë§ Usu√°rio v√°lido: ${user.nome} (${user.email})`, 'success');
                        updateSystemStatus('Autentica√ß√£o OK', 'ok');
                        return true;
                    } else {
                        log('auth-results', `‚ùå Token inv√°lido: ${response.status}`, 'error');
                        updateSystemStatus('Token inv√°lido', 'error');
                        return false;
                    }
                } catch (error) {
                    log('auth-results', `‚ùå Erro ao validar token: ${error.message}`, 'error');
                    updateSystemStatus('Erro de rede', 'error');
                    return false;
                }
            } else {
                log('auth-results', '‚ùå Nenhum token encontrado! Fa√ßa login primeiro.', 'error');
                updateSystemStatus('Sem autentica√ß√£o', 'error');
                return false;
            }
        }

        function limparAuth() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('athletica_token');
            localStorage.removeItem('user');
            globalToken = null;
            clearResults('auth-results');
            log('auth-results', 'üßπ Todos os dados de autentica√ß√£o foram limpos', 'info');
            updateSystemStatus('Auth limpa', 'pending');
        }

        async function buscarMensagensGeral() {
            clearResults('api-results');
            
            if (!globalToken) {
                log('api-results', '‚ùå Execute "Verificar Token" primeiro!', 'error');
                return;
            }
            
            log('api-results', 'üì• Buscando mensagens do Chat Geral (esporteId: 0)...', 'info');
            
            try {
                const response = await fetch(`${baseURL}/api/mensagens/0`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${globalToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                log('api-results', `üì° Status: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const mensagens = await response.json();
                    mensagensEncontradas = mensagens;
                    
                    log('api-results', `‚úÖ ${mensagens.length} mensagem(ns) encontrada(s)`, 'success');
                    
                    if (mensagens.length > 0) {
                        log('api-results', 'üìã Estrutura das mensagens:', 'info');
                        log('api-results', `<pre>${JSON.stringify(mensagens, null, 2)}</pre>`, 'info');
                        
                        // An√°lise dos problemas
                        let problemasEncontrados = 0;
                        mensagens.forEach((msg, index) => {
                            const temTexto = msg.texto && msg.texto.trim() !== '';
                            const temConteudo = msg.conteudo && msg.conteudo.trim() !== '';
                            const temNome = msg.remetente?.nome && msg.remetente.nome.trim() !== '';
                            
                            if (!temTexto && !temConteudo) {
                                log('api-results', `‚ùå Mensagem ${index + 1}: SEM CONTE√öDO`, 'error');
                                problemasEncontrados++;
                            }
                            
                            if (!temNome) {
                                log('api-results', `‚ùå Mensagem ${index + 1}: SEM NOME DO REMETENTE`, 'error');
                                problemasEncontrados++;
                            }
                        });
                        
                        if (problemasEncontrados === 0) {
                            log('api-results', '‚úÖ Todas as mensagens t√™m dados completos!', 'success');
                        } else {
                            log('api-results', `‚ö†Ô∏è ${problemasEncontrados} problema(s) encontrado(s) nos dados`, 'warning');
                        }
                    } else {
                        log('api-results', 'üìù Nenhuma mensagem no Chat Geral (normal se n√£o h√° mensagens)', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log('api-results', `‚ùå Erro HTTP: ${errorText}`, 'error');
                    
                    if (response.status === 404) {
                        log('api-results', 'üí° 404: Chat Geral pode n√£o existir ainda', 'warning');
                    } else if (response.status === 403) {
                        log('api-results', 'üí° 403: Problema de permiss√£o', 'warning');
                    }
                }
                
            } catch (error) {
                log('api-results', `‚ùå Erro de rede: ${error.message}`, 'error');
            }
        }

        async function enviarMensagemTeste() {
            if (!globalToken) {
                log('api-results', '‚ùå Execute "Verificar Token" primeiro!', 'error');
                return;
            }
            
            const mensagemTeste = `üß™ Teste de debug - ${new Date().toLocaleTimeString()}`;
            log('api-results', `üì§ Enviando: "${mensagemTeste}"`, 'info');
            
            try {
                const response = await fetch(`${baseURL}/api/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${globalToken}`
                    },
                    body: JSON.stringify({
                        esporteId: "0",
                        texto: mensagemTeste
                    })
                });

                log('api-results', `üì° Status envio: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const novaMensagem = await response.json();
                    log('api-results', '‚úÖ Mensagem enviada com sucesso!', 'success');
                    log('api-results', `<pre>${JSON.stringify(novaMensagem, null, 2)}</pre>`, 'success');
                    
                    // Aguardar e buscar novamente
                    setTimeout(() => {
                        log('api-results', 'üîÑ Buscando mensagens novamente...', 'info');
                        buscarMensagensGeral();
                    }, 1000);
                } else {
                    const errorText = await response.text();
                    log('api-results', `‚ùå Erro ao enviar: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log('api-results', `‚ùå Erro de rede: ${error.message}`, 'error');
            }
        }

        function analisarEstrutura() {
            clearResults('api-results');
            
            if (mensagensEncontradas.length === 0) {
                log('api-results', '‚ö†Ô∏è Execute "Buscar Mensagens" primeiro!', 'warning');
                return;
            }
            
            log('api-results', 'üîç Analisando estrutura dos dados...', 'info');
            
            mensagensEncontradas.forEach((msg, index) => {
                log('api-results', `üì® An√°lise da Mensagem ${index + 1}:`, 'info');
                log('api-results', `   ID: ${msg.id || 'AUSENTE'}`, msg.id ? 'success' : 'error');
                log('api-results', `   EsporteId: ${msg.esporteId || 'AUSENTE'}`, msg.esporteId ? 'success' : 'error');
                log('api-results', `   Texto: "${msg.texto || 'VAZIO'}"`, msg.texto ? 'success' : 'error');
                log('api-results', `   Conteudo: "${msg.conteudo || 'VAZIO'}"`, msg.conteudo ? 'success' : 'error');
                log('api-results', `   Remetente.nome: "${msg.remetente?.nome || 'VAZIO'}"`, msg.remetente?.nome ? 'success' : 'error');
                log('api-results', `   Remetente.email: "${msg.remetente?.email || 'VAZIO'}"`, msg.remetente?.email ? 'success' : 'error');
                log('api-results', `   Data: ${msg.criadaEm || 'AUSENTE'}`, msg.criadaEm ? 'success' : 'error');
                
                // Simular como apareceria no frontend
                const textoFinal = msg.texto || 'Mensagem sem conte√∫do';
                const nomeFinal = msg.remetente?.nome || 'Usu√°rio';
                
                log('api-results', `   üëÅÔ∏è Como apareceria: "${nomeFinal}: ${textoFinal}"`, 'info');
                
                if (textoFinal === 'Mensagem sem conte√∫do' && nomeFinal === 'Usu√°rio') {
                    log('api-results', '   üéØ BINGO! Este √© o problema relatado!', 'error');
                } else if (textoFinal === 'Mensagem sem conte√∫do') {
                    log('api-results', '   ‚ö†Ô∏è Problema: Sem conte√∫do da mensagem', 'warning');
                } else if (nomeFinal === 'Usu√°rio') {
                    log('api-results', '   ‚ö†Ô∏è Problema: Sem nome do remetente', 'warning');
                } else {
                    log('api-results', '   ‚úÖ Dados OK para esta mensagem', 'success');
                }
            });
        }

        function simularModal() {
            clearResults('frontend-results');
            log('frontend-results', 'üé≠ Simulando comportamento do ModalMensagens...', 'info');
            
            // Simular dados problem√°ticos
            const mensagensSimuladas = [
                {
                    id: "1",
                    esporteId: "0",
                    texto: "",
                    remetente: { nome: "" },
                    criadaEm: new Date().toISOString()
                },
                {
                    id: "2", 
                    esporteId: "0",
                    texto: "Mensagem normal",
                    remetente: { nome: "Jo√£o Silva" },
                    criadaEm: new Date().toISOString()
                }
            ];
            
            log('frontend-results', 'üìã Dados simulados:', 'info');
            log('frontend-results', `<pre>${JSON.stringify(mensagensSimuladas, null, 2)}</pre>`, 'info');
            
            // Simular renderiza√ß√£o (c√≥digo do ModalMensagens.tsx)
            log('frontend-results', 'üé® Simulando renderiza√ß√£o do React:', 'info');
            
            mensagensSimuladas.forEach((mensagem, index) => {
                // C√≥digo do ModalMensagens.tsx linhas 243-255
                const nomeExibido = mensagem.remetente?.nome || 'Usu√°rio';
                const textoExibido = mensagem.texto || 'Mensagem sem conte√∫do';
                
                log('frontend-results', `Mensagem ${index + 1}:`, 'info');
                log('frontend-results', `   Nome: "${nomeExibido}"`, nomeExibido === 'Usu√°rio' ? 'error' : 'success');
                log('frontend-results', `   Texto: "${textoExibido}"`, textoExibido === 'Mensagem sem conte√∫do' ? 'error' : 'success');
                
                if (nomeExibido === 'Usu√°rio' && textoExibido === 'Mensagem sem conte√∫do') {
                    log('frontend-results', '   üéØ REPRODUZIU O PROBLEMA!', 'error');
                }
            });
        }

        function simularFiltros() {
            clearResults('frontend-results');
            log('frontend-results', 'üîç Testando filtros do frontend...', 'info');
            
            const mensagemsChatGeral = [
                { id: "1", esporteId: "0", texto: "Msg 1" },
                { id: "2", esporteId: "0", texto: "Msg 2" },
                { id: "3", esporteId: "1", texto: "Msg de outro esporte" }
            ];
            
            log('frontend-results', 'üìã Mensagens originais (3 total):', 'info');
            log('frontend-results', `<pre>${JSON.stringify(mensagemsChatGeral, null, 2)}</pre>`, 'info');
            
            // Filtro ANTIGO (problem√°tico) - REMOVIDO na corre√ß√£o
            log('frontend-results', '‚ùå Filtro ANTIGO (problem√°tico - J√Å REMOVIDO):', 'error');
            const filtroAntigo = mensagemsChatGeral.filter(msg => msg.esporteId === "0");
            log('frontend-results', `   Resultado: ${filtroAntigo.length} mensagens`, 'error');
            log('frontend-results', '   Problema: API j√° filtra, filtro duplo remove tudo!', 'error');
            
            // Comportamento NOVO (corrigido)
            log('frontend-results', '‚úÖ Comportamento NOVO (corrigido):', 'success');
            log('frontend-results', `   Resultado: ${mensagemsChatGeral.length} mensagens (sem filtro extra)`, 'success');
            log('frontend-results', '   Corre√ß√£o: Removido filtro duplo desnecess√°rio', 'success');
        }

        function simularRenderizacao() {
            clearResults('frontend-results');
            log('frontend-results', 'üé® Simulando renderiza√ß√£o completa...', 'info');
            
            if (mensagensEncontradas.length === 0) {
                log('frontend-results', '‚ö†Ô∏è Execute "Buscar Mensagens" primeiro para dados reais!', 'warning');
                return;
            }
            
            // Usar dados reais da API
            log('frontend-results', `üì® Renderizando ${mensagensEncontradas.length} mensagem(ns) real(is):`, 'info');
            
            mensagensEncontradas.forEach((mensagem, index) => {
                // C√≥digo exato do ModalMensagens.tsx
                const nomeExibido = mensagem.remetente?.nome || 'Usu√°rio';
                const textoExibido = mensagem.texto || 'Mensagem sem conte√∫do';
                const dataExibida = new Date(mensagem.criadaEm).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                log('frontend-results', `üì® Mensagem ${index + 1} renderizada:`, 'info');
                log('frontend-results', `   üë§ Nome: "${nomeExibido}"`, 'info');
                log('frontend-results', `   üí¨ Texto: "${textoExibido}"`, 'info');
                log('frontend-results', `   üìÖ Data: "${dataExibida}"`, 'info');
                
                // Verificar se √© o problema relatado
                if (nomeExibido === 'Usu√°rio' && textoExibido === 'Mensagem sem conte√∫do') {
                    log('frontend-results', '   üéØ PROBLEMA IDENTIFICADO: S√≥ mostra "usu√°rio" e data!', 'error');
                } else if (nomeExibido === 'Usu√°rio') {
                    log('frontend-results', '   ‚ö†Ô∏è Problema parcial: Nome gen√©rico', 'warning');
                } else if (textoExibido === 'Mensagem sem conte√∫do') {
                    log('frontend-results', '   ‚ö†Ô∏è Problema parcial: Sem conte√∫do', 'warning');
                } else {
                    log('frontend-results', '   ‚úÖ Esta mensagem renderiza corretamente', 'success');
                }
            });
        }

        async function testeCompleto() {
            clearResults('final-results');
            log('final-results', 'üöÄ EXECUTANDO TESTE COMPLETO...', 'info');
            
            updateSystemStatus('Executando teste completo...', 'pending');
            
            // 1. Verificar autentica√ß√£o
            log('final-results', '1Ô∏è‚É£ Verificando autentica√ß√£o...', 'info');
            const authOk = await verificarAuth();
            
            if (!authOk) {
                log('final-results', '‚ùå FALHA: Sem autentica√ß√£o v√°lida', 'error');
                updateSystemStatus('Teste falhou - sem auth', 'error');
                return;
            }
            
            // 2. Buscar mensagens
            log('final-results', '2Ô∏è‚É£ Buscando mensagens...', 'info');
            await buscarMensagensGeral();
            
            // 3. An√°lise final
            log('final-results', '3Ô∏è‚É£ An√°lise final...', 'info');
            
            if (mensagensEncontradas.length === 0) {
                log('final-results', '‚ö†Ô∏è RESULTADO: Nenhuma mensagem encontrada', 'warning');
                log('final-results', 'üí° Isso pode ser normal se o chat est√° vazio', 'info');
                log('final-results', 'üîß A√á√ÉO: Tente enviar uma mensagem de teste', 'info');
                updateSystemStatus('Chat vazio (normal)', 'ok');
            } else {
                let problemasEncontrados = 0;
                let mensagensOk = 0;
                
                mensagensEncontradas.forEach(msg => {
                    const temTexto = msg.texto && msg.texto.trim() !== '';
                    const temNome = msg.remetente?.nome && msg.remetente.nome.trim() !== '';
                    
                    if (!temTexto || !temNome) {
                        problemasEncontrados++;
                    } else {
                        mensagensOk++;
                    }
                });
                
                if (problemasEncontrados === 0) {
                    log('final-results', '‚úÖ RESULTADO: Todas as mensagens est√£o OK!', 'success');
                    log('final-results', 'üéâ O problema foi CORRIGIDO!', 'success');
                    updateSystemStatus('Sistema funcionando', 'ok');
                } else {
                    log('final-results', `‚ùå RESULTADO: ${problemasEncontrados} mensagem(ns) com problema`, 'error');
                    log('final-results', `‚úÖ ${mensagensOk} mensagem(ns) funcionando corretamente`, 'success');
                    log('final-results', 'üîß PROBLEMA: Dados incompletos do backend', 'error');
                    updateSystemStatus('Dados incompletos', 'error');
                }
            }
            
            log('final-results', 'üèÅ TESTE COMPLETO FINALIZADO', 'info');
        }

        // Auto-executar verifica√ß√£o inicial
        window.onload = () => {
            updateSystemStatus('Carregando...', 'pending');
            verificarAuth();
        };
    </script>
</body>
</html>
