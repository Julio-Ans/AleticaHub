<!DOCTYPE html>
<html>
<head>
    <title>Teste Firebase Login</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        window.testarFirebaseLogin = async function() {
            const resultDiv = document.getElementById('resultado');
            
            try {
                resultDiv.innerHTML = '<p>üîÑ Obtendo configura√ß√£o Firebase...</p>';
                
                // 1. Buscar configura√ß√£o do Firebase
                const configResponse = await fetch('https://atleticahubapi.onrender.com/config/firebase');
                if (!configResponse.ok) {
                    throw new Error('Erro ao obter configura√ß√£o Firebase');
                }
                
                const firebaseConfig = await configResponse.json();
                resultDiv.innerHTML += '<p>‚úÖ Configura√ß√£o Firebase obtida</p>';
                console.log('Firebase config:', firebaseConfig);
                
                // 2. Inicializar Firebase
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                resultDiv.innerHTML += '<p>‚úÖ Firebase inicializado</p>';
                
                // 3. Tentar login
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                resultDiv.innerHTML += '<p>üîë Fazendo login Firebase...</p>';
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const idToken = await userCredential.user.getIdToken();
                
                resultDiv.innerHTML += '<p>‚úÖ Login Firebase bem-sucedido!</p>';
                resultDiv.innerHTML += `<p>ID Token: ${idToken.substring(0, 50)}...</p>`;
                
                // 4. Enviar ID Token para backend
                resultDiv.innerHTML += '<p>üì° Enviando ID Token para backend...</p>';
                
                const backendResponse = await fetch('https://atleticahubapi.onrender.com/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        idToken: idToken,
                        email: email,
                        displayName: email.split('@')[0]
                    })
                });
                
                if (backendResponse.ok) {
                    const data = await backendResponse.json();
                    
                    // Salvar JWT token
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('athletica_token', data.token);
                    
                    resultDiv.innerHTML += '<p style="color: green;">üéâ Login completo bem-sucedido!</p>';
                    resultDiv.innerHTML += `<p>Usu√°rio: ${data.user.nome}</p>`;
                    resultDiv.innerHTML += '<p>JWT Token salvo no localStorage</p>';
                    
                    // Verificar token salvo
                    document.getElementById('token-status').innerHTML = `
                        <p><strong>Token salvo:</strong> ${localStorage.getItem('authToken') ? 'SIM' : 'N√ÉO'}</p>
                    `;
                    
                } else {
                    const error = await backendResponse.text();
                    resultDiv.innerHTML += `<p style="color: red;">‚ùå Erro no backend: ${error}</p>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<p style="color: red;">‚ùå Erro: ${error.message}</p>`;
                console.error('Erro completo:', error);
            }
        };
    </script>
</head>
<body>
    <h1>Teste Firebase Login Completo</h1>
    
    <form onsubmit="event.preventDefault(); testarFirebaseLogin();">
        <div>
            <label>Email:</label>
            <input type="email" id="email" value="admin@test.com" required>
        </div>
        <div>
            <label>Senha:</label>
            <input type="password" id="password" value="123456" required>
        </div>
        <button type="submit">Fazer Login Firebase</button>
    </form>
    
    <div id="resultado"></div>
    <div id="token-status"></div>
    
    <div>
        <button onclick="
            const token = localStorage.getItem('authToken');
            if (token) {
                document.getElementById('test-api').innerHTML = 'Token presente, testando API...';
                fetch('https://atleticahubapi.onrender.com/api/esportes', {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(r => r.json()).then(data => {
                    document.getElementById('test-api').innerHTML = 'Esportes carregados: ' + data.length;
                }).catch(err => {
                    document.getElementById('test-api').innerHTML = 'Erro: ' + err.message;
                });
            } else {
                document.getElementById('test-api').innerHTML = 'Nenhum token dispon√≠vel';
            }
        ">Testar API com Token</button>
        <div id="test-api"></div>
    </div>
</body>
</html>
