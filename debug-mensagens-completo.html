<!DOCTYPE html>
<html>
<head>
    <title>🔍 Debug Completo - Sistema de Mensagens</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; }
        .result { background: #222; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { border-left: 4px solid #0f0; }
        .error { border-left: 4px solid #f00; }
        .warning { border-left: 4px solid #ff0; }
        .info { border-left: 4px solid #0ff; }
        button { background: #0066cc; color: white; padding: 10px 16px; border: none; border-radius: 4px; margin: 5px; cursor: pointer; }
        input, textarea { background: #333; color: white; border: 1px solid #555; padding: 8px; margin: 5px; border-radius: 4px; width: 300px; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 Debug Completo - Sistema de Mensagens</h1>
    
    <div>
        <h3>🔑 Etapa 1: Verificar Token</h3>
        <button onclick="verificarToken()">🔍 Verificar Token Salvo</button>
        <button onclick="limparTokens()">🧹 Limpar Tokens</button>
    </div>
    
    <div>
        <h3>📡 Etapa 2: Testar API</h3>
        <input type="text" id="esporteId" placeholder="Esporte ID" value="0">
        <br>
        <textarea id="mensagemTexto" placeholder="Mensagem para teste">Olá! Esta é uma mensagem de teste do sistema.</textarea>
        <br>
        <button onclick="testarEnviarMensagem()">📤 Enviar Mensagem</button>
        <button onclick="testarBuscarMensagens()">📥 Buscar Mensagens</button>
    </div>
    
    <div>
        <h3>🧪 Etapa 3: Debug Frontend</h3>
        <button onclick="simularUseMensagens()">🔄 Simular useMensagens</button>
        <button onclick="verificarDadosModal()">📋 Verificar Modal</button>
    </div>
    
    <div>
        <h3>📊 Resultados</h3>
        <button onclick="limpar()">🧹 Limpar</button>
    </div>
    
    <div id="resultado"></div>

    <script>
        const baseURL = 'https://atleticahubapi.onrender.com';
        let tokenAtual = null;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            document.getElementById('resultado').appendChild(div);
            console.log(message);
        }
        
        function limpar() {
            document.getElementById('resultado').innerHTML = '';
        }

        function verificarToken() {
            log('🔍 Verificando tokens salvos...', 'info');
            
            const authToken = localStorage.getItem('authToken');
            const athleticaToken = localStorage.getItem('athletica_token');
            
            log(`🔑 authToken: ${authToken ? 'Encontrado (' + authToken.substring(0, 30) + '...)' : 'Não encontrado'}`, authToken ? 'success' : 'warning');
            log(`🔑 athletica_token: ${athleticaToken ? 'Encontrado (' + athleticaToken.substring(0, 30) + '...)' : 'Não encontrado'}`, athleticaToken ? 'success' : 'warning');
            
            tokenAtual = authToken || athleticaToken;
            
            if (tokenAtual) {
                log(`✅ Token selecionado para testes: ${tokenAtual.substring(0, 50)}...`, 'success');
            } else {
                log('❌ Nenhum token encontrado! Faça login primeiro.', 'error');
            }
            
            // Verificar dados do usuário salvos
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    log(`👤 Usuário salvo: ${user.nome} (${user.email})`, 'info');
                } catch (e) {
                    log('⚠️ Dados de usuário corrompidos', 'warning');
                }
            } else {
                log('❓ Nenhum dado de usuário salvo', 'warning');
            }
        }

        function limparTokens() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('athletica_token');
            localStorage.removeItem('user');
            tokenAtual = null;
            log('🧹 Todos os tokens e dados foram limpos', 'info');
        }

        async function testarEnviarMensagem() {
            if (!tokenAtual) {
                log('❌ Token necessário! Execute "Verificar Token" primeiro.', 'error');
                return;
            }
            
            const esporteId = document.getElementById('esporteId').value;
            const mensagem = document.getElementById('mensagemTexto').value;
            
            log(`📤 Tentando enviar mensagem...`, 'info');
            log(`📋 Dados: esporteId="${esporteId}", mensagem="${mensagem.substring(0, 50)}..."`, 'info');
            
            // Teste 1: Com campo 'texto'
            try {
                log('🧪 Teste 1: Enviando com campo "texto"', 'warning');
                
                const response1 = await fetch(`${baseURL}/api/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenAtual}`
                    },
                    body: JSON.stringify({
                        esporteId: esporteId,
                        texto: mensagem
                    })
                });

                log(`📡 Resposta: ${response1.status} ${response1.statusText}`, 'info');
                
                if (response1.ok) {
                    const data = await response1.json();
                    log('✅ SUCESSO com campo "texto"!', 'success');
                    log(`📨 Mensagem criada: ${JSON.stringify(data, null, 2)}`, 'success');
                    return; // Se funcionou, não precisamos testar mais
                } else {
                    const errorText = await response1.text();
                    log(`❌ Falhou com "texto": ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`❌ Erro de rede com "texto": ${error.message}`, 'error');
            }
            
            // Teste 2: Com campo 'conteudo'
            try {
                log('🧪 Teste 2: Enviando com campo "conteudo"', 'warning');
                
                const response2 = await fetch(`${baseURL}/api/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenAtual}`
                    },
                    body: JSON.stringify({
                        esporteId: esporteId,
                        conteudo: mensagem
                    })
                });

                log(`📡 Resposta: ${response2.status} ${response2.statusText}`, 'info');
                
                if (response2.ok) {
                    const data = await response2.json();
                    log('✅ SUCESSO com campo "conteudo"!', 'success');
                    log(`📨 Mensagem criada: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response2.text();
                    log(`❌ Falhou com "conteudo": ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`❌ Erro de rede com "conteudo": ${error.message}`, 'error');
            }
        }

        async function testarBuscarMensagens() {
            if (!tokenAtual) {
                log('❌ Token necessário! Execute "Verificar Token" primeiro.', 'error');
                return;
            }
            
            const esporteId = document.getElementById('esporteId').value;
            
            log(`📥 Buscando mensagens do esporte ${esporteId}...`, 'info');
            
            try {
                const response = await fetch(`${baseURL}/api/mensagens/${esporteId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${tokenAtual}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`📡 Resposta: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const mensagens = await response.json();
                    log(`✅ ${mensagens.length} mensagem(ns) encontrada(s)`, 'success');
                    
                    if (mensagens.length > 0) {
                        log('📋 Estrutura das mensagens encontradas:', 'info');
                        mensagens.forEach((msg, index) => {
                            log(`📨 Mensagem ${index + 1}:`, 'info');
                            log(`<pre>${JSON.stringify(msg, null, 2)}</pre>`, 'info');
                            
                            // Verificar campos específicos
                            const temTexto = msg.texto !== undefined;
                            const temConteudo = msg.conteudo !== undefined;
                            const conteudoReal = msg.texto || msg.conteudo || 'SEM CONTEÚDO';
                            
                            log(`   🔍 Campo 'texto': ${temTexto ? '✅ Presente' : '❌ Ausente'}`, temTexto ? 'success' : 'error');
                            log(`   🔍 Campo 'conteudo': ${temConteudo ? '✅ Presente' : '❌ Ausente'}`, temConteudo ? 'success' : 'error');
                            log(`   💬 Conteúdo: "${conteudoReal}"`, 'info');
                            log(`   👤 Remetente: ${msg.remetente?.nome || 'Sem nome'}`, 'info');
                            log(`   📅 Data: ${msg.criadaEm}`, 'info');
                        });
                    }
                } else {
                    const errorText = await response.text();
                    log(`❌ Erro ao buscar mensagens: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`❌ Erro de rede: ${error.message}`, 'error');
            }
        }

        function simularUseMensagens() {
            log('🔄 Simulando comportamento do hook useMensagens...', 'info');
            
            // Simular dados típicos que o frontend envia
            const dadosEnvio = {
                esporteId: document.getElementById('esporteId').value,
                texto: document.getElementById('mensagemTexto').value.trim()
            };
            
            log(`📤 Dados que useMensagens enviaria: ${JSON.stringify(dadosEnvio, null, 2)}`, 'info');
            
            // Simular renderização no modal
            const mensagemSimulada = {
                id: 'sim-' + Date.now(),
                remetenteId: 'user123',
                esporteId: dadosEnvio.esporteId,
                texto: dadosEnvio.texto,
                criadaEm: new Date().toISOString(),
                remetente: {
                    nome: 'Usuário Teste',
                    email: 'teste@exemplo.com'
                }
            };
            
            log(`📋 Como apareceria no modal: ${JSON.stringify(mensagemSimulada, null, 2)}`, 'success');
            
            // Verificar se o texto seria exibido
            const textoExibido = mensagemSimulada.texto || 'Mensagem sem conteúdo';
            log(`💬 Texto que seria exibido: "${textoExibido}"`, textoExibido === 'Mensagem sem conteúdo' ? 'error' : 'success');
        }

        function verificarDadosModal() {
            log('📋 Verificando dados simulados do ModalMensagens...', 'info');
            
            // Simular mensagem que aparece apenas como "usuário" + data
            const mensagemProblematica = {
                id: 'prob-1',
                remetenteId: 'user456',
                esporteId: '0',
                texto: '', // PROBLEMA: campo vazio
                conteudo: '', // PROBLEMA: campo vazio também
                criadaEm: new Date().toISOString(),
                remetente: {
                    nome: '', // PROBLEMA: nome vazio
                    email: 'user@test.com'
                }
            };
            
            log('🐛 Mensagem problemática simulada:', 'warning');
            log(`<pre>${JSON.stringify(mensagemProblematica, null, 2)}</pre>`, 'warning');
            
            // Simular como seria renderizada
            const nomeExibido = mensagemProblematica.remetente?.nome || 'Usuário';
            const textoExibido = mensagemProblematica.texto || 'Mensagem sem conteúdo';
            
            log(`👤 Nome que apareceria: "${nomeExibido}"`, 'info');
            log(`💬 Texto que apareceria: "${textoExibido}"`, textoExibido === 'Mensagem sem conteúdo' ? 'error' : 'success');
            
            if (nomeExibido === 'Usuário' && textoExibido === 'Mensagem sem conteúdo') {
                log('🎯 BINGO! Essa é exatamente a situação relatada: só aparece "usuário" e data!', 'error');
                log('💡 Soluções possíveis:', 'info');
                log('   1. Verificar se backend está salvando o campo texto corretamente', 'info');
                log('   2. Verificar se o campo remetente.nome está sendo preenchido', 'info');
                log('   3. Verificar se frontend está enviando os dados corretos', 'info');
            }
        }

        // Auto-executar verificação de token ao carregar
        window.onload = () => {
            verificarToken();
        };
    </script>
</body>
</html>
