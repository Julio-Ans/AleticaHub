<!DOCTYPE html>
<html>
<head>
    <title>ğŸ” Debug Completo - Sistema de Mensagens</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; }
        .result { background: #222; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { border-left: 4px solid #0f0; }
        .error { border-left: 4px solid #f00; }
        .warning { border-left: 4px solid #ff0; }
        .info { border-left: 4px solid #0ff; }
        button { background: #0066cc; color: white; padding: 10px 16px; border: none; border-radius: 4px; margin: 5px; cursor: pointer; }
        input, textarea { background: #333; color: white; border: 1px solid #555; padding: 8px; margin: 5px; border-radius: 4px; width: 300px; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” Debug Completo - Sistema de Mensagens</h1>
    
    <div>
        <h3>ğŸ”‘ Etapa 1: Verificar Token</h3>
        <button onclick="verificarToken()">ğŸ” Verificar Token Salvo</button>
        <button onclick="limparTokens()">ğŸ§¹ Limpar Tokens</button>
    </div>
    
    <div>
        <h3>ğŸ“¡ Etapa 2: Testar API</h3>
        <input type="text" id="esporteId" placeholder="Esporte ID" value="0">
        <br>
        <textarea id="mensagemTexto" placeholder="Mensagem para teste">OlÃ¡! Esta Ã© uma mensagem de teste do sistema.</textarea>
        <br>
        <button onclick="testarEnviarMensagem()">ğŸ“¤ Enviar Mensagem</button>
        <button onclick="testarBuscarMensagens()">ğŸ“¥ Buscar Mensagens</button>
    </div>
    
    <div>
        <h3>ğŸ§ª Etapa 3: Debug Frontend</h3>
        <button onclick="simularUseMensagens()">ğŸ”„ Simular useMensagens</button>
        <button onclick="verificarDadosModal()">ğŸ“‹ Verificar Modal</button>
    </div>
    
    <div>
        <h3>ğŸ“Š Resultados</h3>
        <button onclick="limpar()">ğŸ§¹ Limpar</button>
    </div>
    
    <div id="resultado"></div>

    <script>
        const baseURL = 'https://atleticahubapi.onrender.com';
        let tokenAtual = null;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            document.getElementById('resultado').appendChild(div);
            console.log(message);
        }
        
        function limpar() {
            document.getElementById('resultado').innerHTML = '';
        }

        function verificarToken() {
            log('ğŸ” Verificando tokens salvos...', 'info');
            
            const authToken = localStorage.getItem('authToken');
            const athleticaToken = localStorage.getItem('athletica_token');
            
            log(`ğŸ”‘ authToken: ${authToken ? 'Encontrado (' + authToken.substring(0, 30) + '...)' : 'NÃ£o encontrado'}`, authToken ? 'success' : 'warning');
            log(`ğŸ”‘ athletica_token: ${athleticaToken ? 'Encontrado (' + athleticaToken.substring(0, 30) + '...)' : 'NÃ£o encontrado'}`, athleticaToken ? 'success' : 'warning');
            
            tokenAtual = authToken || athleticaToken;
            
            if (tokenAtual) {
                log(`âœ… Token selecionado para testes: ${tokenAtual.substring(0, 50)}...`, 'success');
            } else {
                log('âŒ Nenhum token encontrado! FaÃ§a login primeiro.', 'error');
            }
            
            // Verificar dados do usuÃ¡rio salvos
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    log(`ğŸ‘¤ UsuÃ¡rio salvo: ${user.nome} (${user.email})`, 'info');
                } catch (e) {
                    log('âš ï¸ Dados de usuÃ¡rio corrompidos', 'warning');
                }
            } else {
                log('â“ Nenhum dado de usuÃ¡rio salvo', 'warning');
            }
        }

        function limparTokens() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('athletica_token');
            localStorage.removeItem('user');
            tokenAtual = null;
            log('ğŸ§¹ Todos os tokens e dados foram limpos', 'info');
        }

        async function testarEnviarMensagem() {
            if (!tokenAtual) {
                log('âŒ Token necessÃ¡rio! Execute "Verificar Token" primeiro.', 'error');
                return;
            }
            
            const esporteId = document.getElementById('esporteId').value;
            const mensagem = document.getElementById('mensagemTexto').value;
            
            log(`ğŸ“¤ Tentando enviar mensagem...`, 'info');
            log(`ğŸ“‹ Dados: esporteId="${esporteId}", mensagem="${mensagem.substring(0, 50)}..."`, 'info');
            
            // Teste 1: Com campo 'texto'
            try {
                log('ğŸ§ª Teste 1: Enviando com campo "texto"', 'warning');
                
                const response1 = await fetch(`${baseURL}/api/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenAtual}`
                    },
                    body: JSON.stringify({
                        esporteId: esporteId,
                        texto: mensagem
                    })
                });

                log(`ğŸ“¡ Resposta: ${response1.status} ${response1.statusText}`, 'info');
                
                if (response1.ok) {
                    const data = await response1.json();
                    log('âœ… SUCESSO com campo "texto"!', 'success');
                    log(`ğŸ“¨ Mensagem criada: ${JSON.stringify(data, null, 2)}`, 'success');
                    return; // Se funcionou, nÃ£o precisamos testar mais
                } else {
                    const errorText = await response1.text();
                    log(`âŒ Falhou com "texto": ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro de rede com "texto": ${error.message}`, 'error');
            }
            
            // Teste 2: Com campo 'conteudo'
            try {
                log('ğŸ§ª Teste 2: Enviando com campo "conteudo"', 'warning');
                
                const response2 = await fetch(`${baseURL}/api/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenAtual}`
                    },
                    body: JSON.stringify({
                        esporteId: esporteId,
                        conteudo: mensagem
                    })
                });

                log(`ğŸ“¡ Resposta: ${response2.status} ${response2.statusText}`, 'info');
                
                if (response2.ok) {
                    const data = await response2.json();
                    log('âœ… SUCESSO com campo "conteudo"!', 'success');
                    log(`ğŸ“¨ Mensagem criada: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response2.text();
                    log(`âŒ Falhou com "conteudo": ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro de rede com "conteudo": ${error.message}`, 'error');
            }
        }

        async function testarBuscarMensagens() {
            if (!tokenAtual) {
                log('âŒ Token necessÃ¡rio! Execute "Verificar Token" primeiro.', 'error');
                return;
            }
            
            const esporteId = document.getElementById('esporteId').value;
            
            log(`ğŸ“¥ Buscando mensagens do esporte ${esporteId}...`, 'info');
            
            try {
                const response = await fetch(`${baseURL}/api/mensagens/${esporteId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${tokenAtual}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`ğŸ“¡ Resposta: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const mensagens = await response.json();
                    log(`âœ… ${mensagens.length} mensagem(ns) encontrada(s)`, 'success');
                    
                    if (mensagens.length > 0) {
                        log('ğŸ“‹ Estrutura das mensagens encontradas:', 'info');
                        mensagens.forEach((msg, index) => {
                            log(`ğŸ“¨ Mensagem ${index + 1}:`, 'info');
                            log(`<pre>${JSON.stringify(msg, null, 2)}</pre>`, 'info');
                            
                            // Verificar campos especÃ­ficos
                            const temTexto = msg.texto !== undefined;
                            const temConteudo = msg.conteudo !== undefined;
                            const conteudoReal = msg.texto || msg.conteudo || 'SEM CONTEÃšDO';
                            
                            log(`   ğŸ” Campo 'texto': ${temTexto ? 'âœ… Presente' : 'âŒ Ausente'}`, temTexto ? 'success' : 'error');
                            log(`   ğŸ” Campo 'conteudo': ${temConteudo ? 'âœ… Presente' : 'âŒ Ausente'}`, temConteudo ? 'success' : 'error');
                            log(`   ğŸ’¬ ConteÃºdo: "${conteudoReal}"`, 'info');
                            log(`   ğŸ‘¤ Remetente: ${msg.remetente?.nome || 'Sem nome'}`, 'info');
                            log(`   ğŸ“… Data: ${msg.criadaEm}`, 'info');
                        });
                    }
                } else {
                    const errorText = await response.text();
                    log(`âŒ Erro ao buscar mensagens: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro de rede: ${error.message}`, 'error');
            }
        }

        function simularUseMensagens() {
            log('ğŸ”„ Simulando comportamento do hook useMensagens...', 'info');
            
            // Simular dados tÃ­picos que o frontend envia
            const dadosEnvio = {
                esporteId: document.getElementById('esporteId').value,
                texto: document.getElementById('mensagemTexto').value.trim()
            };
            
            log(`ğŸ“¤ Dados que useMensagens enviaria: ${JSON.stringify(dadosEnvio, null, 2)}`, 'info');
            
            // Simular renderizaÃ§Ã£o no modal
            const mensagemSimulada = {
                id: 'sim-' + Date.now(),
                remetenteId: 'user123',
                esporteId: dadosEnvio.esporteId,
                texto: dadosEnvio.texto,
                criadaEm: new Date().toISOString(),
                remetente: {
                    nome: 'UsuÃ¡rio Teste',
                    email: 'teste@exemplo.com'
                }
            };
            
            log(`ğŸ“‹ Como apareceria no modal: ${JSON.stringify(mensagemSimulada, null, 2)}`, 'success');
            
            // Verificar se o texto seria exibido
            const textoExibido = mensagemSimulada.texto || 'Mensagem sem conteÃºdo';
            log(`ğŸ’¬ Texto que seria exibido: "${textoExibido}"`, textoExibido === 'Mensagem sem conteÃºdo' ? 'error' : 'success');
        }

        function verificarDadosModal() {
            log('ğŸ“‹ Verificando dados simulados do ModalMensagens...', 'info');
            
            // Simular mensagem que aparece apenas como "usuÃ¡rio" + data
            const mensagemProblematica = {
                id: 'prob-1',
                remetenteId: 'user456',
                esporteId: '0',
                texto: '', // PROBLEMA: campo vazio
                conteudo: '', // PROBLEMA: campo vazio tambÃ©m
                criadaEm: new Date().toISOString(),
                remetente: {
                    nome: '', // PROBLEMA: nome vazio
                    email: 'user@test.com'
                }
            };
            
            log('ğŸ› Mensagem problemÃ¡tica simulada:', 'warning');
            log(`<pre>${JSON.stringify(mensagemProblematica, null, 2)}</pre>`, 'warning');
            
            // Simular como seria renderizada
            const nomeExibido = mensagemProblematica.remetente?.nome || 'UsuÃ¡rio';
            const textoExibido = mensagemProblematica.texto || 'Mensagem sem conteÃºdo';
            
            log(`ğŸ‘¤ Nome que apareceria: "${nomeExibido}"`, 'info');
            log(`ğŸ’¬ Texto que apareceria: "${textoExibido}"`, textoExibido === 'Mensagem sem conteÃºdo' ? 'error' : 'success');
            
            if (nomeExibido === 'UsuÃ¡rio' && textoExibido === 'Mensagem sem conteÃºdo') {
                log('ğŸ¯ BINGO! Essa Ã© exatamente a situaÃ§Ã£o relatada: sÃ³ aparece "usuÃ¡rio" e data!', 'error');
                log('ğŸ’¡ SoluÃ§Ãµes possÃ­veis:', 'info');
                log('   1. Verificar se backend estÃ¡ salvando o campo texto corretamente', 'info');
                log('   2. Verificar se o campo remetente.nome estÃ¡ sendo preenchido', 'info');
                log('   3. Verificar se frontend estÃ¡ enviando os dados corretos', 'info');
            }
        }

        // Auto-executar verificaÃ§Ã£o de token ao carregar
        window.onload = () => {
            verificarToken();
        };
    </script>
</body>
</html>
